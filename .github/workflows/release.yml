name: Kernel Build with SukiSU & SUSFS

on:
  workflow_dispatch:
    inputs:
      sukisu_branch:
        description: 'SukiSU Branch'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Stable
      enable_susfs:
        description: 'Enable SUSFS'
        required: true
        default: true
        type: boolean
      release_version:
        description: 'Release Version'
        required: false
        default: 'OP13-A16-DEFAULT'
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: LineageOS/android_kernel_oneplus_sm8750
          ref: lineage-23.0

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex libssl-dev \
            gcc clang lld git wget curl zip unzip

      - name: Clone SukiSU
        run: |
          git clone -b ${{ github.event.inputs.sukisu_branch }} \
            https://github.com/spacealtctrl/a16_sony_sm8550_SukiSU_SUSFS.git sukiSU

      - name: Apply SUSFS patches (if enabled)
        if: ${{ github.event.inputs.enable_susfs == 'true' }}
        run: |
          cd sukiSU/susfs_patches
          for patch in *.patch; do
            git apply --directory=../.. "$patch"
          done

      - name: Export release version
        run: echo "RELEASE_VERSION=OP13-A16-$(date +'%Y%m%d.%H%M%S)" >> $GITHUB_ENV

      - name: Build kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export RELEASE_VERSION=$RELEASE_VERSION

          make O=out lineage_defconfig
          make O=out -j$(nproc)

      - name: Package kernel
        run: |
          cd out/arch/arm64/boot
          zip -r kernel-${RELEASE_VERSION}.zip Image.gz-dtb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ env.RELEASE_VERSION }}
          path: out/arch/arm64/boot/kernel-${RELEASE_VERSION}.zip
